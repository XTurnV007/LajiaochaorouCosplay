# 迷雾剧场架构设计文档

## 📋 项目概述

### 项目信息
- **项目名称**：迷雾剧场 - 竹林之下
- **项目类型**：基于Web的AI互动推理游戏
- **技术栈**：HTML5 + CSS3 + Vanilla JavaScript + AI API
- **目标平台**：现代Web浏览器（桌面端 + 移动端）

### 核心功能
1. **AI驱动的角色对话系统**
2. **语音合成与播放功能**
3. **互动式现场调查**
4. **证物收集与管理**
5. **游戏状态持久化**
6. **响应式用户界面**

## 🏗️ 系统架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层 (UI Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  封面页    │  调查界面  │  审问界面  │  结果页面  │  设置面板   │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (Logic Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  游戏控制器 │ AI对话系统 │ 语音管理器 │ 证物系统 │ 状态管理器  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Layer)                  │
├─────────────────────────────────────────────────────────────┤
│   本地存储   │   AI API   │   语音API   │  静态资源  │  配置数据  │
└─────────────────────────────────────────────────────────────┘
```

### 技术选型
- **前端框架**：Vanilla JavaScript（原生JS，无依赖）
- **样式方案**：CSS3 + Flexbox + Grid
- **状态管理**：自定义GameState类 + LocalStorage
- **AI服务**：七牛云API（兼容OpenAI格式）
- **语音服务**：TTS API（文本转语音）
- **构建工具**：无需构建，直接运行

## 📁 文件结构与模块规格

### 目录结构
```
LajiaochaorouCosplay/
├── index.html              # 主页面文件
├── styles.css              # 样式文件
├── script.js               # 主逻辑文件
├── 运行说明.md              # 用户文档
├── 架构设计文档.md          # 技术文档
└── images/                 # 静态资源目录
    ├── cover.png           # 封面背景
    ├── crime_scene.png     # 案发现场图
    ├── characters/         # 角色头像
    │   ├── onitake.png     # 大盗鬼武
    │   ├── hana.png        # 花子夫人
    │   ├── spirit.png      # 武士之魂
    │   └── woodcutter.png  # 樵夫吉二郎
    └── items/              # 证物图片
        ├── rope_marks.png
        ├── broken_sword.png
        ├── rope_and_hairpin.png
        ├── trampled_area.png
        └── missing_dagger.png
```

### 核心模块规格

#### 1. 游戏状态管理模块 (GameState)
**文件位置**：`script.js` (Lines 155-310)
**职责**：
- 管理游戏全局状态
- 处理数据持久化
- 管理session机制

**主要方法**：
```javascript
class GameState {
    constructor()           // 初始化游戏状态
    saveGameState()         // 保存状态到本地存储
    loadGameState()         // 从本地存储加载状态
    addEvidence(evidence)   // 添加证物到证物袋
    updateEvidenceDisplay() // 更新证物显示
    clearGameState()        // 清除游戏数据
}
```

**数据结构**：
- `currentScreen`: 当前显示的界面
- `evidence`: 收集到的证物数组
- `conversations`: 对话记录对象
- `sceneInvestigations`: 现场调查记录
- `voiceEnabled`: 语音功能开关状态

#### 2. AI对话系统模块 (AIConversation)
**文件位置**：`script.js` (Lines 442-892)
**职责**：
- 管理与AI的对话交互
- 处理角色性格和情绪状态
- 实现压力系统和情绪变化

**主要方法**：
```javascript
class AIConversation {
    constructor(suspectId)                    // 初始化对话
    getInitialStatement()                     // 获取初始证词
    generateResponse(message, evidence)       // 生成AI回复
    callAIAPI(message, evidence)             // 调用AI API
    buildSystemPrompt(evidence)              // 构建系统提示词
    getStressIncrease(evidenceId)            // 计算压力增加
}
```

**核心特性**：
- 角色一致性保持
- 动态压力等级系统
- 证物关联反应
- 情绪状态跟踪

#### 3. 语音管理模块 (VoiceManager)
**文件位置**：`script.js` (Lines 2-152)
**职责**：
- 文本转语音功能
- 音频播放控制
- 角色音色管理

**主要方法**：
```javascript
class VoiceManager {
    constructor()                           // 初始化语音管理器
    textToSpeech(text, characterId)        // 文本转语音
    playAudio(audioUrl)                    // 播放音频
    stopAudio()                            // 停止音频播放
    getVoiceForCharacter(characterId)      // 获取角色音色
}
```

**技术实现**：
- 使用七牛云TTS API
- Base64音频数据处理
- Blob URL管理
- 音频资源自动释放

#### 4. 界面控制模块
**文件位置**：`script.js` (Lines 895-1198, 1936-2095)
**职责**：
- 界面切换控制
- 事件监听管理
- 用户交互处理

**主要功能**：
- 屏幕和面板切换：`showScreen()`, `showPanel()`
- 封面页控制：`initializeCover()`
- 通知系统：`showNotification()`
- 响应式设计适配

#### 5. 现场调查模块
**文件位置**：`script.js` (Lines 1632-1868)
**职责**：
- 现场交互处理
- 热点区域管理
- 证物发现机制

**主要功能**：
- 热点位置动态计算：`adjustHotspotPositions()`
- 调查结果处理：`investigateHotspot()`
- 热点显示控制：`toggleHotspots()`
- 调查状态恢复：`restoreSceneState()`

#### 6. 审问系统模块
**文件位置**：`script.js` (Lines 1287-1630)
**职责**：
- 角色审问流程
- 消息发送处理
- 证据出示功能

**主要功能**：
- 聊天界面审问：`startChatInterrogation()`
- 消息发送：`sendMessage()`
- 证据出示：`presentEvidence()`
- 状态显示更新：`updateChatSuspectStatus()`

#### 7. 结案系统模块
**文件位置**：`script.js` (Lines 1871-1955)
**职责**：
- 推理结果评估
- 破案判定逻辑
- 结果展示

**主要功能**：
- 指认提交：`submitAccusation()`
- 答案评估：`evaluateAccusation()`
- 结果显示：`showResult()`

## 🎨 UI/UX设计规范

### 设计理念
- **沉浸式体验**：古典与现代结合的视觉风格
- **直观操作**：简化的交互流程，降低学习成本
- **响应式设计**：适配多种设备尺寸
- **无障碍访问**：支持键盘导航和屏幕阅读器

### 色彩方案
```css
/* 主色调 */
--primary-red: #e74c3c     /* 主题红色 */
--primary-gold: #f39c12    /* 金色强调 */
--dark-blue: #2c3e50      /* 深蓝背景 */
--light-blue: #3498db     /* 浅蓝高亮 */

/* 功能色 */
--success: #27ae60        /* 成功绿色 */
--warning: #f39c12        /* 警告橙色 */
--danger: #e74c3c         /* 危险红色 */
--info: #3498db           /* 信息蓝色 */
```

### 组件规范

#### 按钮系统
- **主按钮**：渐变背景，悬停动效
- **次按钮**：边框样式，简洁风格
- **危险按钮**：红色警告，慎重操作

#### 卡片组件
- **角色卡片**：头像+信息，悬停交互
- **证物卡片**：图片+描述，点击高亮
- **消息卡片**：聊天气泡，角色区分

#### 表单控件
- **输入框**：透明背景，聚焦高亮
- **选择框**：深色主题适配
- **复选框**：自定义样式，状态反馈

### 响应式断点
```css
/* 移动端 */
@media (max-width: 480px) { /* 手机 */ }
@media (max-width: 768px) { /* 平板 */ }

/* 桌面端 */
@media (min-width: 769px) { /* 小桌面 */ }
@media (min-width: 1024px) { /* 大桌面 */ }
```

## 🔧 技术实现细节

### 状态持久化策略
1. **Session管理**：每次页面加载生成唯一session ID
2. **数据分层**：
   - 永久数据：对话记录、语音设置
   - 临时数据：证物袋、现场调查（每session重置）
3. **存储优化**：JSON序列化，自动清理过期数据

### AI集成方案
1. **API适配层**：统一不同AI服务商的接口
2. **提示词工程**：
   - 角色一致性系统提示词
   - 动态上下文构建
   - 压力等级响应机制
3. **错误处理**：降级到本地逻辑，保证游戏可玩性

### 性能优化
1. **资源加载**：图片预加载，渐进式显示
2. **内存管理**：音频资源及时释放，避免内存泄漏
3. **缓存策略**：LocalStorage缓存，减少重复请求
4. **响应式图片**：多尺寸适配，按需加载

### 安全考虑
1. **API密钥保护**：前端展示风险提示
2. **输入验证**：防止恶意输入，内容过滤
3. **错误处理**：不暴露敏感系统信息
4. **跨域安全**：CORS配置，API域名限制

## 📊 数据流图

### 游戏启动流程
```
用户访问 → 加载资源 → 初始化GameState → 显示封面页 → 用户配置 → 开始游戏
```

### 审问对话流程
```
选择角色 → 初始化对话 → 用户输入 → 构建提示词 → 调用AI API → 处理响应 → 更新状态 → 语音播放
```

### 现场调查流程
```
点击热点 → 检查调查状态 → 执行调查逻辑 → 更新证物袋 → 记录调查历史 → 保存状态
```

## 🚀 部署方案

### 开发环境
- 本地文件系统直接运行
- 推荐使用本地HTTP服务器
- 实时预览和调试

### 生产部署
1. **静态网站托管**：
   - GitHub Pages
   - Netlify
   - Vercel
   - 阿里云OSS

2. **CDN优化**：
   - 图片资源CDN加速
   - 静态文件压缩
   - 缓存策略配置

3. **域名配置**：
   - HTTPS强制重定向
   - 自定义域名绑定
   - DNS解析优化

## 🔮 未来扩展计划

### 功能扩展
1. **多剧本支持**：模块化剧本系统
2. **多人协作**：实时协作推理
3. **成就系统**：解锁条件和奖励
4. **回放功能**：案件过程回顾

### 技术升级
1. **WebRTC集成**：实时语音对话
2. **PWA支持**：离线游戏能力
3. **AI模型本地化**：减少网络依赖
4. **区块链集成**：去中心化存档

### 平台拓展
1. **移动应用**：React Native/Flutter
2. **桌面应用**：Electron封装
3. **VR版本**：沉浸式体验
4. **小程序版本**：微信生态集成

---

## 📝 开发规范

### 代码规范
- 使用ES6+语法特性
- 遵循驼峰命名规范
- 函数职责单一化
- 充分的错误处理

### 注释规范
- 类和方法必须有注释
- 复杂逻辑添加行内注释
- TODO标记待处理事项
- 版本更新日志记录

### 测试策略
- 手动功能测试
- 跨浏览器兼容性测试
- 响应式设计测试
- API异常情况测试

这份架构文档为项目的后续开发和维护提供了完整的技术指南。